<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transport Office â€“ à¸£à¸°à¸šà¸šà¸‚à¸™à¸ªà¹ˆà¸‡</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <!-- Flatpickr calendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
/* â”€â”€â”€ Reset & base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --navy:    #0d2f5e;
  --blue:    #1557c0;
  --blue-m:  #1e6fe0;
  --sky:     #3b9eff;
  --ice:     #e8f1fd;
  --ice2:    #f0f6ff;
  --white:   #ffffff;
  --gray-50: #f7f9fc;
  --gray-100:#eef2f8;
  --gray-200:#d8e2f0;
  --gray-400:#8fa6c4;
  --gray-600:#4f6a8a;
  --gray-800:#1e3454;
  --red:     #d63b3b;
  --green:   #1a8c5c;
  --amber:   #d67b00;
  --shadow:  0 1px 3px rgba(13,47,94,.08), 0 4px 16px rgba(13,47,94,.06);
  --shadow-lg: 0 4px 12px rgba(13,47,94,.12), 0 12px 40px rgba(13,47,94,.10);
  --radius:  10px;
  --radius-lg: 16px;
  --sidebar: 220px;
  --font: 'IBM Plex Sans Thai', sans-serif;
  --mono: 'IBM Plex Mono', monospace;
}

html, body { height: 100%; font-family: var(--font); font-size: 14px; color: var(--gray-800); background: var(--gray-50); }

/* â”€â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app-shell { display: flex; height: 100vh; overflow: hidden; }

/* â”€â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
  width: var(--sidebar);
  flex-shrink: 0;
  background: var(--navy);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-logo {
  padding: 22px 20px 20px;
  border-bottom: 1px solid rgba(255,255,255,.08);
}
.logo-icon {
  font-size: 22px;
  line-height: 1;
}
.logo-title {
  font-size: 15px;
  font-weight: 700;
  color: #fff;
  letter-spacing: .02em;
  margin-top: 8px;
}
.logo-sub {
  font-size: 11px;
  color: rgba(255,255,255,.45);
  margin-top: 2px;
  letter-spacing: .03em;
}

.sidebar-nav {
  flex: 1;
  padding: 14px 12px;
  display: flex;
  flex-direction: column;
  gap: 2px;
  overflow-y: auto;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 8px;
  cursor: pointer;
  color: rgba(255,255,255,.60);
  font-size: 13px;
  font-weight: 500;
  transition: background .15s, color .15s;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
}
.nav-item:hover { background: rgba(255,255,255,.07); color: rgba(255,255,255,.85); }
.nav-item.active { background: var(--blue-m); color: #fff; }
.nav-icon { font-size: 16px; line-height: 1; flex-shrink: 0; }

.sidebar-footer {
  padding: 14px 12px;
  border-top: 1px solid rgba(255,255,255,.08);
}
.btn-refresh {
  width: 100%;
  padding: 9px 12px;
  border-radius: 8px;
  background: rgba(255,255,255,.09);
  border: 1px solid rgba(255,255,255,.14);
  color: rgba(255,255,255,.75);
  font-family: var(--font);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: background .15s, color .15s;
  display: flex; align-items: center; justify-content: center; gap: 6px;
}
.btn-refresh:hover { background: rgba(255,255,255,.16); color: #fff; }

/* â”€â”€â”€ Main area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.topbar {
  height: 56px;
  background: var(--white);
  border-bottom: 1px solid var(--gray-200);
  display: flex;
  align-items: center;
  padding: 0 28px;
  gap: 12px;
  flex-shrink: 0;
}
.topbar-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--navy);
}
.topbar-sub {
  font-size: 12px;
  color: var(--gray-400);
  margin-left: 2px;
}
.topbar-spacer { flex: 1; }
.topbar-time {
  font-size: 12px;
  color: var(--gray-400);
  font-family: var(--mono);
}

.content {
  flex: 1;
  overflow-y: auto;
  padding: 24px 28px;
}

/* â”€â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: var(--white);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
}
.card-header {
  padding: 18px 22px 0;
  display: flex;
  align-items: center;
  gap: 10px;
}
.card-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--navy);
}
.card-body { padding: 16px 22px 20px; }
.card-body + .card-body { padding-top: 0; }

.section-gap { margin-bottom: 18px; }

/* â”€â”€â”€ Form elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-grid {
  display: grid;
  gap: 12px 16px;
}
.cols-4 { grid-template-columns: repeat(4, 1fr); }
.cols-3 { grid-template-columns: repeat(3, 1fr); }
.cols-2 { grid-template-columns: repeat(2, 1fr); }
.col-span-2 { grid-column: span 2; }
.col-span-3 { grid-column: span 3; }
.col-span-4 { grid-column: span 4; }

.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--gray-600);
  letter-spacing: .03em;
  text-transform: uppercase;
}
.form-control, .form-select {
  padding: 8px 12px;
  border: 1.5px solid var(--gray-200);
  border-radius: 8px;
  font-family: var(--font);
  font-size: 13.5px;
  color: var(--gray-800);
  background: var(--white);
  outline: none;
  transition: border-color .15s, box-shadow .15s;
  width: 100%;
}
.form-control:focus, .form-select:focus {
  border-color: var(--blue-m);
  box-shadow: 0 0 0 3px rgba(30,111,224,.12);
}
.form-control::placeholder { color: var(--gray-400); }

/* Flatpickr date input styling */
.form-control.flatpickr-input { cursor: pointer; }

/* â”€â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 8px 18px;
  border-radius: 8px;
  font-family: var(--font);
  font-size: 13.5px;
  font-weight: 600;
  cursor: pointer;
  transition: background .15s, box-shadow .15s, transform .1s;
  border: none;
  white-space: nowrap;
}
.btn:active { transform: translateY(1px); }
.btn-primary {
  background: var(--blue);
  color: #fff;
  box-shadow: 0 2px 8px rgba(21,87,192,.30);
}
.btn-primary:hover { background: var(--blue-m); box-shadow: 0 4px 12px rgba(21,87,192,.40); }
.btn-outline {
  background: transparent;
  color: var(--blue);
  border: 1.5px solid var(--blue);
}
.btn-outline:hover { background: var(--ice); }
.btn-danger {
  background: var(--red);
  color: #fff;
}
.btn-sm { padding: 5px 12px; font-size: 12px; }
.btn-full { width: 100%; }
.align-btn { align-self: flex-end; }

/* â”€â”€â”€ Tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap { overflow-x: auto; margin-top: 12px; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
thead tr { background: var(--gray-50); border-bottom: 2px solid var(--gray-200); }
th {
  padding: 9px 12px;
  font-size: 11.5px;
  font-weight: 700;
  color: var(--gray-600);
  text-align: left;
  letter-spacing: .04em;
  text-transform: uppercase;
  white-space: nowrap;
}
td {
  padding: 10px 12px;
  border-bottom: 1px solid var(--gray-100);
  color: var(--gray-800);
  vertical-align: middle;
}
tbody tr:hover { background: var(--ice2); }
tbody tr:last-child td { border-bottom: none; }
.text-right { text-align: right; }
.text-center { text-align: center; }

/* â”€â”€â”€ Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 3px 9px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: .04em;
}
.badge-new     { background: #e8f4ff; color: #0369a1; }
.badge-planned { background: #fef3c7; color: #92400e; }
.badge-assigned{ background: #ede9fe; color: #5b21b6; }
.badge-inprogress { background: #dbeafe; color: #1d4ed8; }
.badge-delivered{ background: #d1fae5; color: #065f46; }
.badge-closed  { background: #f1f5f9; color: #475569; }

/* â”€â”€â”€ Alert / toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.msg { margin-top: 14px; }
.alert {
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
}
.alert-success { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
.alert-danger  { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

/* â”€â”€â”€ Stat cards (summary) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 18px; }
.stat-card {
  background: var(--white);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-lg);
  padding: 20px 22px;
  box-shadow: var(--shadow);
}
.stat-label { font-size: 11px; font-weight: 700; color: var(--gray-400); letter-spacing: .06em; text-transform: uppercase; }
.stat-value { font-size: 28px; font-weight: 700; color: var(--navy); margin-top: 6px; font-family: var(--mono); }
.stat-unit  { font-size: 12px; color: var(--gray-400); font-family: var(--font); font-weight: 400; margin-left: 4px; }

/* â”€â”€â”€ Chart containers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.charts-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 18px; }
.chart-card {
  background: var(--white);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-lg);
  padding: 20px 22px;
  box-shadow: var(--shadow);
}
.chart-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--navy);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.chart-container {
  position: relative;
  height: 280px;
}

/* â”€â”€â”€ Mono / code text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mono { font-family: var(--mono); font-size: 12.5px; }
.pre-box {
  background: #0f1f38;
  color: #a8d0ff;
  padding: 14px 16px;
  border-radius: 10px;
  font-family: var(--mono);
  font-size: 12px;
  line-height: 1.7;
  overflow-x: auto;
  margin-top: 12px;
}

/* â”€â”€â”€ Filter row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.filter-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 4px;
}
.filter-row .card-title { margin: 0; }
.filter-select {
  padding: 5px 10px;
  border: 1.5px solid var(--gray-200);
  border-radius: 8px;
  font-family: var(--font);
  font-size: 12.5px;
  color: var(--gray-800);
  background: var(--white);
  outline: none;
  cursor: pointer;
}
.filter-select:focus { border-color: var(--blue-m); }

/* â”€â”€â”€ Divider inside card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card-divider {
  border: none;
  border-top: 1px solid var(--gray-100);
  margin: 4px 0;
}

/* â”€â”€â”€ Section label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-label {
  font-size: 11px;
  font-weight: 700;
  color: var(--blue);
  letter-spacing: .08em;
  text-transform: uppercase;
  padding: 0 22px 12px;
}

/* â”€â”€â”€ Setup alert â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.setup-alert {
  background: #fffbeb;
  border: 1px solid #fcd34d;
  border-radius: var(--radius);
  padding: 12px 16px;
  font-size: 13px;
  color: #78350f;
  margin-bottom: 20px;
  display: flex;
  gap: 10px;
  align-items: flex-start;
}
.setup-alert code {
  font-family: var(--mono);
  font-size: 11px;
  background: rgba(0,0,0,.08);
  padding: 2px 5px;
  border-radius: 4px;
  word-break: break-all;
}

/* â”€â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--gray-200); border-radius: 999px; }
::-webkit-scrollbar-thumb:hover { background: var(--gray-400); }

/* â”€â”€â”€ Flatpickr override â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.flatpickr-calendar { font-family: var(--font) !important; border-radius: 12px !important; box-shadow: var(--shadow-lg) !important; border: 1px solid var(--gray-200) !important; }
.flatpickr-day.selected, .flatpickr-day.selected:hover { background: var(--blue) !important; border-color: var(--blue) !important; }
.flatpickr-day:hover { background: var(--ice) !important; }
.flatpickr-months .flatpickr-prev-month:hover svg,
.flatpickr-months .flatpickr-next-month:hover svg { fill: var(--blue) !important; }
</style>
</head>
<body>

<div class="app-shell">

  <!-- â”€â”€ Sidebar â”€â”€ -->
  <nav class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">ğŸšš</div>
      <div class="logo-title">Transport Office</div>
      <div class="logo-sub">à¸£à¸°à¸šà¸šà¸ˆà¸±à¸”à¸à¸²à¸£à¸‚à¸™à¸ªà¹ˆà¸‡</div>
    </div>

    <div class="sidebar-nav">
      <button class="nav-item active" data-tab="tabOrder">
        <span class="nav-icon">ğŸ“¥</span> à¸£à¸±à¸šà¸­à¸­à¹€à¸”à¸­à¸£à¹Œ
      </button>
      <button class="nav-item" data-tab="tabPlan">
        <span class="nav-icon">ğŸ—ºï¸</span> à¸§à¸²à¸‡à¹à¸œà¸™ / à¸¡à¸­à¸šà¸«à¸¡à¸²à¸¢
      </button>
      <button class="nav-item" data-tab="tabFuel">
        <span class="nav-icon">â›½</span> à¸šà¸±à¸™à¸—à¸¶à¸à¸™à¹‰à¸³à¸¡à¸±à¸™
      </button>
      <button class="nav-item" data-tab="tabSummary">
        <span class="nav-icon">ğŸ“Š</span> à¸ªà¸£à¸¸à¸›à¸•à¹‰à¸™à¸—à¸¸à¸™
      </button>
      <button class="nav-item" data-tab="tabData">
        <span class="nav-icon">âš™ï¸</span> à¸ˆà¸±à¸”à¸à¸²à¸£à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
      </button>
    </div>

    <div class="sidebar-footer">
      <button class="btn-refresh" onclick="loadAll()">
        <span>â†»</span> à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
      </button>
    </div>
  </nav>

  <!-- â”€â”€ Main â”€â”€ -->
  <div class="main">

    <!-- Topbar -->
    <header class="topbar">
      <span class="topbar-title" id="topbarTitle">à¸£à¸±à¸šà¸­à¸­à¹€à¸”à¸­à¸£à¹Œ</span>
      <span class="topbar-sub" id="topbarSub">à¸šà¸±à¸™à¸—à¸¶à¸à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸ˆà¸±à¸”à¸ªà¹ˆà¸‡à¸ˆà¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²</span>
      <span class="topbar-spacer"></span>
      <span class="topbar-time" id="clockEl"></span>
    </header>

    <!-- Content -->
    <div class="content">

      <!-- Setup warning -->
      <div class="setup-alert" id="setupAlert">
        âš ï¸ <div>à¸à¸£à¸¸à¸“à¸²à¹à¸à¹‰à¹„à¸‚à¸•à¸±à¸§à¹à¸›à¸£ <code>SCRIPT_URL</code> à¹ƒà¸™à¹„à¸Ÿà¸¥à¹Œà¸™à¸µà¹‰à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™à¸¥à¸´à¸‡à¸à¹Œ <code>/exec</code> à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸ˆà¸²à¸ Google Apps Script Deploy à¸à¹ˆà¸­à¸™à¹ƒà¸Šà¹‰à¸‡à¸²à¸™</div>
      </div>

      <!-- â”€â”€ TAB 1: Orders â”€â”€ -->
      <div id="tabOrder" class="tab-pane">
        <!-- Form card -->
        <div class="card section-gap">
          <div class="card-header">
            <span>ğŸ“¥</span>
            <span class="card-title">à¸šà¸±à¸™à¸—à¸¶à¸à¸­à¸­à¹€à¸”à¸­à¸£à¹Œà¹ƒà¸«à¸¡à¹ˆ</span>
          </div>
          <div class="card-body">
            <div class="form-grid cols-4">
              <div class="form-group col-span-2">
                <label class="form-label">à¸¥à¸¹à¸à¸„à¹‰à¸²</label>
                <select id="customerId" class="form-select"></select>
              </div>
              <div class="form-group">
                <label class="form-label">à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡</label>
                <input id="shipDate" class="form-control date-picker" placeholder="à¹€à¸¥à¸·à¸­à¸à¸§à¸±à¸™à¸—à¸µà¹ˆ" readonly>
              </div>
              <div class="form-group">
                <label class="form-label">à¸ˆà¸¸à¸”à¸ªà¹ˆà¸‡ (à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡)</label>
                <input id="destination" class="form-control" placeholder="à¹€à¸Šà¹ˆà¸™ à¹‚à¸„à¸£à¸²à¸Š / à¹‚à¸£à¸‡à¸‡à¸²à¸™ A">
              </div>

              <div class="form-group col-span-2">
                <label class="form-label">à¸ªà¸´à¸™à¸„à¹‰à¸²</label>
                <select id="product" class="form-select"></select>
              </div>
              <div class="form-group">
                <label class="form-label">à¸ˆà¸³à¸™à¸§à¸™</label>
                <input id="qty" class="form-control" type="number" step="0.01" placeholder="à¹€à¸Šà¹ˆà¸™ 30">
              </div>
              <div class="form-group">
                <label class="form-label">à¸«à¸™à¹ˆà¸§à¸¢</label>
                <input id="unit" class="form-control" value="à¸•à¸±à¸™">
              </div>

              <div class="form-group">
                <label class="form-label">à¸£à¸²à¸„à¸² / à¸«à¸™à¹ˆà¸§à¸¢ (à¸šà¸²à¸—)</label>
                <input id="ppu" class="form-control" type="number" step="0.01" placeholder="0 = à¸‚à¹‰à¸²à¸¡à¹„à¸”à¹‰">
              </div>
              <div class="form-group col-span-2">
                <label class="form-label">à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸</label>
                <input id="orderNote" class="form-control" placeholder="à¹€à¸Šà¹ˆà¸™ à¸ªà¹ˆà¸‡à¸”à¹ˆà¸§à¸™ / à¹‚à¸—à¸£à¸à¹ˆà¸­à¸™à¸–à¸¶à¸‡">
              </div>
              <div class="form-group align-btn">
                <button class="btn btn-primary" onclick="createOrder()">
                  + à¸šà¸±à¸™à¸—à¸¶à¸à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ
                </button>
              </div>
            </div>
            <div class="msg" id="orderMsg"></div>
          </div>
        </div>

        <!-- Orders list -->
        <div class="card">
          <div class="card-header">
            <div class="filter-row" style="width:100%">
              <span class="card-title">à¸£à¸²à¸¢à¸à¸²à¸£à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ</span>
              <select id="orderStatusFilter" class="filter-select" onchange="loadOrders()">
                <option value="">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</option>
                <option value="NEW">NEW</option>
                <option value="PLANNED">PLANNED</option>
                <option value="ASSIGNED">ASSIGNED</option>
                <option value="CLOSED">CLOSED</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Order ID</th>
                    <th>à¸¥à¸¹à¸à¸„à¹‰à¸²</th>
                    <th>à¸§à¸±à¸™à¸ªà¹ˆà¸‡</th>
                    <th>à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡</th>
                    <th>à¸ªà¸´à¸™à¸„à¹‰à¸²</th>
                    <th class="text-right">à¸ˆà¸³à¸™à¸§à¸™</th>
                    <th class="text-right">à¸£à¸²à¸„à¸²à¸£à¸§à¸¡</th>
                    <th class="text-center">Status</th>
                  </tr>
                </thead>
                <tbody id="ordersTbody">
                  <tr><td colspan="8" class="text-center" style="color:var(--gray-400);padding:24px">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ TAB 2: Plan / Assign â”€â”€ -->
      <div id="tabPlan" class="tab-pane" style="display:none">
        <div class="card section-gap">
          <div class="card-header"><span>ğŸ—ºï¸</span><span class="card-title">à¸§à¸²à¸‡à¹à¸œà¸™à¸™à¹‰à¸³à¸¡à¸±à¸™</span></div>
          <div class="card-body">
            <div class="form-grid cols-4">
              <div class="form-group col-span-2">
                <label class="form-label">à¹€à¸¥à¸·à¸­à¸ Order</label>
                <select id="planOrderId" class="form-select"></select>
              </div>
              <div class="form-group">
                <label class="form-label">à¸™à¹‰à¸³à¸¡à¸±à¸™à¸—à¸µà¹ˆà¸§à¸²à¸‡à¹à¸œà¸™ (à¸¥à¸´à¸•à¸£)</label>
                <input id="plannedLiters" class="form-control" type="number" step="0.01" placeholder="0.00">
              </div>
              <div class="form-group">
                <label class="form-label">à¸‡à¸šà¸™à¹‰à¸³à¸¡à¸±à¸™ (à¸šà¸²à¸—)</label>
                <input id="plannedBudget" class="form-control" type="number" step="0.01" placeholder="0.00">
              </div>
              <div class="form-group align-btn col-span-4" style="align-items:flex-start">
                <button class="btn btn-outline" onclick="planOrder()">ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸œà¸™</button>
              </div>
            </div>
          </div>

          <hr class="card-divider">
          <div class="section-label">à¸¡à¸­à¸šà¸«à¸¡à¸²à¸¢à¸‡à¸²à¸™</div>

          <div class="card-body" style="padding-top:0">
            <div class="form-grid cols-4">
              <div class="form-group">
                <label class="form-label">à¸§à¸±à¸™à¸—à¸µà¹ˆà¸­à¸­à¸à¸§à¸´à¹ˆà¸‡</label>
                <input id="tripDate" class="form-control date-picker" placeholder="à¹€à¸¥à¸·à¸­à¸à¸§à¸±à¸™à¸—à¸µà¹ˆ" readonly>
              </div>
              <div class="form-group col-span-2">
                <label class="form-label">à¸£à¸–</label>
                <select id="truckId" class="form-select"></select>
              </div>
              <div class="form-group">
                <label class="form-label">à¸„à¸™à¸‚à¸±à¸š</label>
                <select id="driverId" class="form-select"></select>
              </div>
              <div class="form-group col-span-3">
                <label class="form-label">à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸ (à¸¡à¸­à¸šà¸«à¸¡à¸²à¸¢)</label>
                <input id="assignNote" class="form-control" placeholder="à¹€à¸Šà¹ˆà¸™ à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡ / à¹€à¸šà¸­à¸£à¹Œà¸•à¸´à¸”à¸•à¹ˆà¸­">
              </div>
              <div class="form-group align-btn">
                <button class="btn btn-primary btn-full" onclick="assignOrder()">âœ“ à¸¡à¸­à¸šà¸«à¸¡à¸²à¸¢</button>
              </div>
            </div>
            <div class="msg" id="planMsg"></div>
          </div>
        </div>

        <!-- Trips list -->
        <div class="card">
          <div class="card-header">
            <div class="filter-row" style="width:100%">
              <span class="card-title">à¸£à¸²à¸¢à¸à¸²à¸£ Trips</span>
              <select id="tripStatusFilter" class="filter-select" onchange="loadTrips()">
                <option value="">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</option>
                <option value="ASSIGNED">ASSIGNED</option>
                <option value="DELIVERED">DELIVERED</option>
                <option value="CLOSED">CLOSED</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Trip ID</th>
                    <th>Order ID</th>
                    <th>à¸§à¸±à¸™à¸—à¸µà¹ˆ</th>
                    <th>à¸£à¸–</th>
                    <th>à¸„à¸™à¸‚à¸±à¸š</th>
                    <th class="text-right">Plan Liters</th>
                    <th class="text-right">Plan Budget</th>
                    <th class="text-center">Status</th>
                  </tr>
                </thead>
                <tbody id="tripsTbody">
                  <tr><td colspan="8" class="text-center" style="color:var(--gray-400);padding:24px">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ TAB 3: Fuel â”€â”€ -->
      <div id="tabFuel" class="tab-pane" style="display:none">
        <div class="card">
          <div class="card-header"><span>â›½</span><span class="card-title">à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸•à¸´à¸¡à¸™à¹‰à¸³à¸¡à¸±à¸™ (à¸•à¸­à¸™à¸à¸¥à¸±à¸š) â€“ à¸›à¸´à¸”à¸‡à¸²à¸™</span></div>
          <div class="card-body">
            <div class="form-grid cols-4">
              <div class="form-group col-span-2">
                <label class="form-label">à¹€à¸¥à¸·à¸­à¸ Trip</label>
                <select id="fuelTripId" class="form-select"></select>
              </div>
              <div class="form-group">
                <label class="form-label">à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸•à¸´à¸¡</label>
                <input id="fuelDate" class="form-control date-picker" placeholder="à¹€à¸¥à¸·à¸­à¸à¸§à¸±à¸™à¸—à¸µà¹ˆ" readonly>
              </div>
              <div class="form-group"><!-- spacer --></div>

              <div class="form-group">
                <label class="form-label">à¸¥à¸´à¸•à¸£</label>
                <input id="fuelLiters" class="form-control" type="number" step="0.01" placeholder="0.00" oninput="calcFuelAmt()">
              </div>
              <div class="form-group">
                <label class="form-label">à¸šà¸²à¸— / à¸¥à¸´à¸•à¸£</label>
                <input id="fuelPpl" class="form-control" type="number" step="0.01" placeholder="0.00" oninput="calcFuelAmt()">
              </div>
              <div class="form-group">
                <label class="form-label">à¸¢à¸­à¸”à¹€à¸‡à¸´à¸™à¸£à¸§à¸¡ (à¸šà¸²à¸—)</label>
                <input id="fuelAmount" class="form-control" type="number" step="0.01" placeholder="à¸„à¸³à¸™à¸§à¸“à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´">
              </div>
              <div class="form-group"><!-- spacer --></div>

              <div class="form-group">
                <label class="form-label">à¹€à¸¥à¸‚à¹„à¸¡à¸¥à¹Œà¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ (à¸à¸¡.)</label>
                <input id="fuelStartOdo" class="form-control" type="number" step="1" placeholder="à¹€à¸Šà¹ˆà¸™ 1000">
              </div>
              <div class="form-group">
                <label class="form-label">à¹€à¸¥à¸‚à¹„à¸¡à¸¥à¹Œà¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸” (à¸à¸¡.)</label>
                <input id="fuelEndOdo" class="form-control" type="number" step="1" placeholder="à¹€à¸Šà¹ˆà¸™ 1260">
              </div>
              <div class="form-group col-span-2">
                <label class="form-label">à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸</label>
                <input id="fuelNote" class="form-control" placeholder="à¹€à¸Šà¹ˆà¸™ à¹€à¸•à¸´à¸¡à¸›à¸±à¹Šà¸¡ PTT / à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆà¹€à¸¥à¸‚à¸—à¸µà¹ˆ...">
              </div>

              <div class="form-group align-btn col-span-4">
                <button class="btn btn-primary" onclick="fuelReturn()">âœ“ à¸šà¸±à¸™à¸—à¸¶à¸ + à¸›à¸´à¸”à¸‡à¸²à¸™</button>
              </div>
            </div>
            <div class="msg" id="fuelMsg"></div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ TAB 4: Summary â”€â”€ -->
      <div id="tabSummary" class="tab-pane" style="display:none">
        <div class="card section-gap">
          <div class="card-header"><span>ğŸ“Š</span><span class="card-title">à¸ªà¸£à¸¸à¸›à¸•à¹‰à¸™à¸—à¸¸à¸™à¸™à¹‰à¸³à¸¡à¸±à¸™</span></div>
          <div class="card-body">
            <div class="form-grid cols-4">
              <div class="form-group">
                <label class="form-label">à¸•à¸±à¹‰à¸‡à¹à¸•à¹ˆà¸§à¸±à¸™à¸—à¸µà¹ˆ</label>
                <input id="sumFrom" class="form-control date-picker" placeholder="à¹€à¸¥à¸·à¸­à¸à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸£à¸´à¹ˆà¸¡" readonly>
              </div>
              <div class="form-group">
                <label class="form-label">à¸–à¸¶à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆ</label>
                <input id="sumTo" class="form-control date-picker" placeholder="à¹€à¸¥à¸·à¸­à¸à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”" readonly>
              </div>
              <div class="form-group align-btn">
                <button class="btn btn-primary" onclick="loadSummary()">à¸”à¸¹à¸ªà¸£à¸¸à¸›</button>
              </div>
            </div>
          </div>
        </div>
        <div id="summaryBox"></div>
      </div>

      <!-- â”€â”€ TAB 5: Data Management â”€â”€ -->
      <div id="tabData" class="tab-pane" style="display:none">
        <div class="card section-gap">
          <div class="card-header"><span>ğŸ‘¥</span><span class="card-title">à¹€à¸à¸´à¹ˆà¸¡à¸¥à¸¹à¸à¸„à¹‰à¸²</span></div>
          <div class="card-body">
            <div class="form-grid cols-3">
              <div class="form-group">
                <label class="form-label">à¸£à¸«à¸±à¸ªà¸¥à¸¹à¸à¸„à¹‰à¸²</label>
                <input id="newCusId" class="form-control" placeholder="à¹€à¸Šà¹ˆà¸™ CUS-001">
              </div>
              <div class="form-group">
                <label class="form-label">à¸Šà¸·à¹ˆà¸­à¸¥à¸¹à¸à¸„à¹‰à¸²</label>
                <input id="newCusName" class="form-control" placeholder="à¹€à¸Šà¹ˆà¸™ à¸šà¸£à¸´à¸©à¸±à¸— ABC à¸ˆà¸³à¸à¸±à¸”">
              </div>
              <div class="form-group align-btn">
                <button class="btn btn-primary" onclick="addCustomer()">+ à¹€à¸à¸´à¹ˆà¸¡à¸¥à¸¹à¸à¸„à¹‰à¸²</button>
              </div>
            </div>
            <div class="msg" id="cusMsg"></div>
          </div>
        </div>

        <div class="card section-gap">
          <div class="card-header"><span>ğŸ“¦</span><span class="card-title">à¹€à¸à¸´à¹ˆà¸¡à¸ªà¸´à¸™à¸„à¹‰à¸²</span></div>
          <div class="card-body">
            <div class="form-grid cols-3">
              <div class="form-group">
                <label class="form-label">à¸£à¸«à¸±à¸ªà¸ªà¸´à¸™à¸„à¹‰à¸²</label>
                <input id="newPrdId" class="form-control" placeholder="à¹€à¸Šà¹ˆà¸™ PRD-001">
              </div>
              <div class="form-group">
                <label class="form-label">à¸Šà¸·à¹ˆà¸­à¸ªà¸´à¸™à¸„à¹‰à¸²</label>
                <input id="newPrdName" class="form-control" placeholder="à¹€à¸Šà¹ˆà¸™ à¸›à¸¹à¸™à¸‹à¸µà¹€à¸¡à¸™à¸•à¹Œ">
              </div>
              <div class="form-group align-btn">
                <button class="btn btn-primary" onclick="addProduct()">+ à¹€à¸à¸´à¹ˆà¸¡à¸ªà¸´à¸™à¸„à¹‰à¸²</button>
              </div>
            </div>
            <div class="msg" id="prdMsg"></div>
          </div>
        </div>

        <div class="card section-gap">
          <div class="card-header"><span>ğŸ‘¨â€âœˆï¸</span><span class="card-title">à¹€à¸à¸´à¹ˆà¸¡à¸à¸™à¸±à¸à¸‡à¸²à¸™à¸‚à¸±à¸šà¸£à¸–</span></div>
          <div class="card-body">
            <div class="form-grid cols-3">
              <div class="form-group">
                <label class="form-label">à¸£à¸«à¸±à¸ªà¸à¸™à¸±à¸à¸‡à¸²à¸™</label>
                <input id="newDrvId" class="form-control" placeholder="à¹€à¸Šà¹ˆà¸™ DRV-001">
              </div>
              <div class="form-group">
                <label class="form-label">à¸Šà¸·à¹ˆà¸­à¸à¸™à¸±à¸à¸‡à¸²à¸™</label>
                <input id="newDrvName" class="form-control" placeholder="à¹€à¸Šà¹ˆà¸™ à¸ªà¸¡à¸Šà¸²à¸¢">
              </div>
              <div class="form-group align-btn">
                <button class="btn btn-primary" onclick="addDriver()">+ à¹€à¸à¸´à¹ˆà¸¡à¸à¸™à¸±à¸à¸‡à¸²à¸™</button>
              </div>
            </div>
            <div class="msg" id="drvMsg"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><span>ğŸš›</span><span class="card-title">à¹€à¸à¸´à¹ˆà¸¡à¸£à¸–à¸‚à¸™à¸ªà¹ˆà¸‡</span></div>
          <div class="card-body">
            <div class="form-grid cols-3">
              <div class="form-group">
                <label class="form-label">à¸£à¸«à¸±à¸ªà¸£à¸–</label>
                <input id="newTrkId" class="form-control" placeholder="à¹€à¸Šà¹ˆà¸™ TRK-001">
              </div>
              <div class="form-group">
                <label class="form-label">à¸Šà¸·à¹ˆà¸­à¸£à¸– / à¸—à¸°à¹€à¸šà¸µà¸¢à¸™</label>
                <input id="newTrkName" class="form-control" placeholder="à¹€à¸Šà¹ˆà¸™ 70-1234">
              </div>
              <div class="form-group align-btn">
                <button class="btn btn-primary" onclick="addTruck()">+ à¹€à¸à¸´à¹ˆà¸¡à¸£à¸–</button>
              </div>
            </div>
            <div class="msg" id="trkMsg"></div>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /app-shell -->

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ğŸ”‘ SCRIPT_URL â€” à¹ƒà¸ªà¹ˆ /exec URL à¸‚à¸­à¸‡ Apps Script à¸—à¸µà¹ˆ Deploy à¹à¸¥à¹‰à¸§
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxcZ1-wcQzti1P7RkBFWB1mT1cf1AG_4DIo3jZBOGnyJQAbOmRQcu3imdEbLtmjSVLw/exec";

/* â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const TAB_META = {
  tabOrder:   { title: "à¸£à¸±à¸šà¸­à¸­à¹€à¸”à¸­à¸£à¹Œ",       sub: "à¸šà¸±à¸™à¸—à¸¶à¸à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸ˆà¸±à¸”à¸ªà¹ˆà¸‡à¸ˆà¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²" },
  tabPlan:    { title: "à¸§à¸²à¸‡à¹à¸œà¸™ / à¸¡à¸­à¸šà¸«à¸¡à¸²à¸¢", sub: "à¸à¸³à¸«à¸™à¸”à¸™à¹‰à¸³à¸¡à¸±à¸™à¹à¸¥à¸°à¸¡à¸­à¸šà¸«à¸¡à¸²à¸¢à¸£à¸–-à¸„à¸™à¸‚à¸±à¸š" },
  tabFuel:    { title: "à¸šà¸±à¸™à¸—à¸¶à¸à¸™à¹‰à¸³à¸¡à¸±à¸™",      sub: "à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¹€à¸•à¸´à¸¡à¸™à¹‰à¸³à¸¡à¸±à¸™à¹à¸¥à¸°à¸›à¸´à¸”à¸‡à¸²à¸™" },
  tabSummary: { title: "à¸ªà¸£à¸¸à¸›à¸•à¹‰à¸™à¸—à¸¸à¸™",        sub: "à¸£à¸²à¸¢à¸‡à¸²à¸™à¸„à¹ˆà¸²à¸™à¹‰à¸³à¸¡à¸±à¸™à¹à¸¢à¸à¸£à¸– / à¸„à¸™à¸‚à¸±à¸š / Order" },
  tabData:    { title: "à¸ˆà¸±à¸”à¸à¸²à¸£à¸‚à¹‰à¸­à¸¡à¸¹à¸¥",      sub: "à¹€à¸à¸´à¹ˆà¸¡/à¹à¸à¹‰à¹„à¸‚ à¸¥à¸¹à¸à¸„à¹‰à¸² à¸ªà¸´à¸™à¸„à¹‰à¸² à¸„à¸™à¸‚à¸±à¸š à¸£à¸–" }
};

document.querySelectorAll(".nav-item[data-tab]").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".nav-item").forEach(x => x.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    document.querySelectorAll(".tab-pane").forEach(p => p.style.display = "none");
    document.getElementById(tab).style.display = "";
    document.getElementById("topbarTitle").textContent = TAB_META[tab].title;
    document.getElementById("topbarSub").textContent   = TAB_META[tab].sub;
  });
});

/* â”€â”€â”€ Clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateClock() {
  document.getElementById("clockEl").textContent =
    new Date().toLocaleString("th-TH", { timeZone:"Asia/Bangkok",
      year:"numeric", month:"2-digit", day:"2-digit",
      hour:"2-digit", minute:"2-digit", second:"2-digit" });
}
setInterval(updateClock, 1000);
updateClock();

/* â”€â”€â”€ Date pickers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initDatePickers() {
  document.querySelectorAll(".date-picker").forEach(el => {
    if (el._fp) return; // already init
    el._fp = flatpickr(el, {
      dateFormat: "Y-m-d",
      allowInput: false,
      disableMobile: true,
      locale: "th"
    });
  });
}

/* â”€â”€â”€ JSONP helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function jsonp(action, params = {}) {
  return new Promise((resolve, reject) => {
    const cb  = "cb_" + Math.random().toString(36).slice(2);
    const url = new URL(SCRIPT_URL);
    url.searchParams.set("action", action);
    url.searchParams.set("callback", cb);
    Object.entries(params).forEach(([k, v]) => {
      if (v !== undefined && v !== null) url.searchParams.set(k, v);
    });

    const script = document.createElement("script");
    script.src = url.toString();
    script.onerror = () => { cleanup(); reject(new Error("JSONP failed")); };
    window[cb] = data => { cleanup(); resolve(data); };
    function cleanup() { delete window[cb]; script.remove(); }
    document.body.appendChild(script);
  });
}

/* â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function esc(s) {
  return String(s ?? "").replace(/[&<>"']/g, m =>
    ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}

function setMsg(id, ok, html) {
  document.getElementById(id).innerHTML =
    `<div class="alert ${ok ? "alert-success" : "alert-danger"}">${ok?"âœ“":"âœ—"} ${html}</div>`;
}

function badgeClass(status) {
  const map = {
    NEW:"badge-new", PLANNED:"badge-planned", ASSIGNED:"badge-assigned",
    IN_PROGRESS:"badge-inprogress", DELIVERED:"badge-delivered", CLOSED:"badge-closed"
  };
  return "badge " + (map[String(status).toUpperCase()] || "badge-closed");
}

function optionize(selectId, items, placeholder = "-- à¹€à¸¥à¸·à¸­à¸ --") {
  const el = document.getElementById(selectId);
  if (!el) return;
  
  // Handle null/undefined items
  if (!items || !Array.isArray(items)) {
    el.innerHTML = `<option value="">${esc(placeholder)}</option>`;
    return;
  }
  
  el.innerHTML = `<option value="">${esc(placeholder)}</option>` +
    items.map(x => `<option value="${esc(x.id)}">${esc(x.name)} &nbsp;(${esc(x.id)})</option>`).join("");
}

function numFmt(v) {
  const n = Number(v);
  return isNaN(n) ? "-" : n.toLocaleString("th-TH", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function calcFuelAmt() {
  const l   = parseFloat(document.getElementById("fuelLiters").value) || 0;
  const ppl = parseFloat(document.getElementById("fuelPpl").value)    || 0;
  if (l && ppl) document.getElementById("fuelAmount").value = (l * ppl).toFixed(2);
}

/* â”€â”€â”€ App state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let DDL = { drivers:[], trucks:[], customers:[], products:[] };

/* â”€â”€â”€ Bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadAll() {
  const setupAlert = document.getElementById("setupAlert");
  if (!SCRIPT_URL || SCRIPT_URL.includes("PASTE_")) {
    setupAlert.style.display = "flex";
    return;
  }
  setupAlert.style.display = "none";

  try {
    const data = await jsonp("bootstrap");
    if (!data.ok) { 
      alert("Bootstrap error: " + (data.error || "Unknown error")); 
      return; 
    }

    DDL = data.ddl || { drivers: [], trucks: [], customers: [], products: [] };
    
    optionize("customerId", DDL.customers || [], "-- à¹€à¸¥à¸·à¸­à¸à¸¥à¸¹à¸à¸„à¹‰à¸² --");
    optionize("product",    DDL.products  || [], "-- à¹€à¸¥à¸·à¸­à¸à¸ªà¸´à¸™à¸„à¹‰à¸² --");
    optionize("truckId",    DDL.trucks    || [], "-- à¹€à¸¥à¸·à¸­à¸à¸£à¸– --");
    optionize("driverId",   DDL.drivers   || [], "-- à¹€à¸¥à¸·à¸­à¸à¸„à¸™à¸‚à¸±à¸š --");

    await Promise.all([loadOrders(), loadTrips(), refreshPickers()]);
  } catch(e) {
    console.error("Bootstrap error:", e);
    alert("Connection error: " + e.message + "\n\nà¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š:\n1. SCRIPT_URL à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ\n2. Deploy Apps Script à¹à¸¥à¹‰à¸§à¸«à¸£à¸·à¸­à¸¢à¸±à¸‡\n3. à¹€à¸›à¸´à¸” Console (F12) à¸”à¸¹ error à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡");
  }
}

async function refreshPickers() {
  const [ordersRes, tripsRes] = await Promise.all([
    jsonp("listOrders", { status: "" }),
    jsonp("listTrips",  { status: "" })  // à¸”à¸¶à¸‡à¸—à¸¸à¸ status
  ]);

  if (ordersRes.ok) {
    // Format: OrderId | CustomerName
    const items = ordersRes.orders.map(o => ({
      id:   o.orderId,
      name: `${o.orderId} | ${o.customerName}`
    }));
    optionize("planOrderId", items, "-- à¹€à¸¥à¸·à¸­à¸ Order --");
  }

  if (tripsRes.ok) {
    // à¸à¸£à¸­à¸‡ Trip à¸—à¸µà¹ˆà¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸›à¸´à¸”à¸‡à¸²à¸™ (à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ CLOSED)
    // Format: TripId | CustomerName
    const items = tripsRes.trips
      .filter(t => String(t.status).toUpperCase() !== "CLOSED")
      .map(t => {
        // Find order info to get customer name
        const order = ordersRes.ok 
          ? ordersRes.orders.find(o => o.orderId === t.orderId)
          : null;
        
        const customerName = order ? order.customerName : '';
        
        return {
          id:   t.tripId,
          name: `${t.tripId} | ${customerName}`
        };
      });
    optionize("fuelTripId", items, "-- à¹€à¸¥à¸·à¸­à¸ Trip --");
  }
}

/* â”€â”€â”€ Orders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function createOrder() {
  const customerId   = document.getElementById("customerId").value;
  const customerName = (DDL.customers.find(x => x.id === customerId) || {}).name || "";
  const shipDate     = document.getElementById("shipDate").value.trim();
  const destination  = document.getElementById("destination").value.trim();
  const productId    = document.getElementById("product").value;
  const productName  = (DDL.products.find(x => x.id === productId) || {}).name || productId;
  const qty          = document.getElementById("qty").value;
  const unit         = document.getElementById("unit").value.trim();
  const pricePerUnit = document.getElementById("ppu").value;
  const note         = document.getElementById("orderNote").value.trim();

  const payload = { customerId, customerName, shipDate, origin: "",
                    destination, product: productName, qty, unit, pricePerUnit, note };
  const encoded = encodeURIComponent(JSON.stringify(payload));
  const res     = await jsonp("createOrder", { payload: encoded });

  if (res.ok) {
    setMsg("orderMsg", true, `à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ Order ID: <b>${esc(res.orderId)}</b>`);
    await loadOrders();
    await refreshPickers();
  } else {
    setMsg("orderMsg", false, esc(res.error || "à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ"));
  }
}

async function loadOrders() {
  const status = document.getElementById("orderStatusFilter").value;
  const res    = await jsonp("listOrders", { status });
  const tb     = document.getElementById("ordersTbody");

  if (!res.ok) {
    tb.innerHTML = `<tr><td colspan="8" class="text-center" style="color:var(--red)">${esc(res.error || "error")}</td></tr>`;
    return;
  }

  if (!res.orders.length) {
    tb.innerHTML = `<tr><td colspan="8" class="text-center" style="color:var(--gray-400);padding:24px">à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥</td></tr>`;
    return;
  }

  tb.innerHTML = res.orders.slice(0, 200).map(o => `
    <tr>
      <td class="mono">${esc(o.orderId)}</td>
      <td>${esc(o.customerName)}</td>
      <td class="mono">${esc(o.shipDate)}</td>
      <td>${esc(o.destination)}</td>
      <td>${esc(o.product)}</td>
      <td class="text-right">${esc(o.qty)} <small style="color:var(--gray-400)">${esc(o.unit)}</small></td>
      <td class="text-right mono">${numFmt(o.totalPrice)}</td>
      <td class="text-center"><span class="${badgeClass(o.status)}">${esc(o.status)}</span></td>
    </tr>
  `).join("");
}

/* â”€â”€â”€ Plan & Assign â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function planOrder() {
  const orderId          = document.getElementById("planOrderId").value;
  const plannedFuelLiters = document.getElementById("plannedLiters").value;
  const plannedFuelBudget = document.getElementById("plannedBudget").value;
  const res              = await jsonp("planOrder", { orderId, plannedFuelLiters, plannedFuelBudget });

  if (res.ok) {
    setMsg("planMsg", true, `à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸œà¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ Order: <b>${esc(orderId)}</b>`);
    await loadOrders();
    await refreshPickers();
  } else {
    setMsg("planMsg", false, esc(res.error || "à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ"));
  }
}

async function assignOrder() {
  const orderId  = document.getElementById("planOrderId").value;
  const tripDate = document.getElementById("tripDate").value.trim();
  const truckId  = document.getElementById("truckId").value;
  const driverId = document.getElementById("driverId").value;
  const note     = document.getElementById("assignNote").value.trim();
  const res      = await jsonp("assignOrder", { orderId, tripDate, truckId, driverId, note });

  if (res.ok) {
    setMsg("planMsg", true, `à¸¡à¸­à¸šà¸«à¸¡à¸²à¸¢à¸ªà¸³à¹€à¸£à¹‡à¸ˆ Trip ID: <b>${esc(res.tripId)}</b>`);
    await Promise.all([loadTrips(), loadOrders(), refreshPickers()]);
  } else {
    setMsg("planMsg", false, esc(res.error || "à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ"));
  }
}

async function loadTrips() {
  const status = document.getElementById("tripStatusFilter").value;
  const res    = await jsonp("listTrips", { status });
  const tb     = document.getElementById("tripsTbody");

  if (!res.ok) {
    tb.innerHTML = `<tr><td colspan="8" class="text-center" style="color:var(--red)">${esc(res.error || "error")}</td></tr>`;
    return;
  }

  if (!res.trips.length) {
    tb.innerHTML = `<tr><td colspan="8" class="text-center" style="color:var(--gray-400);padding:24px">à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥</td></tr>`;
    return;
  }

  tb.innerHTML = res.trips.slice(0, 200).map(t => `
    <tr>
      <td class="mono">${esc(t.tripId)}</td>
      <td class="mono">${esc(t.orderId)}</td>
      <td class="mono">${esc(t.tripDate)}</td>
      <td>${esc(t.truckName || t.truckId)}</td>
      <td>${esc(t.driverName || t.driverId)}</td>
      <td class="text-right mono">${numFmt(t.plannedFuelLiters)}</td>
      <td class="text-right mono">${numFmt(t.plannedFuelBudget)}</td>
      <td class="text-center"><span class="${badgeClass(t.status)}">${esc(t.status)}</span></td>
    </tr>
  `).join("");
}

/* â”€â”€â”€ Fuel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function fuelReturn() {
  const tripId       = document.getElementById("fuelTripId").value;
  const fuelDate     = document.getElementById("fuelDate").value.trim();
  const liters       = document.getElementById("fuelLiters").value;
  const pricePerLiter = document.getElementById("fuelPpl").value;
  const amount       = document.getElementById("fuelAmount").value;
  const note         = document.getElementById("fuelNote").value.trim();
  const startOdo     = document.getElementById("fuelStartOdo").value;
  const endOdo       = document.getElementById("fuelEndOdo").value;
  
  const res = await jsonp("fuelReturn", { 
    tripId, fuelDate, liters, pricePerLiter, amount, note,
    startOdo, endOdo 
  });

  if (res.ok) {
    setMsg("fuelMsg", true,
      `à¸šà¸±à¸™à¸—à¸¶à¸à¸™à¹‰à¸³à¸¡à¸±à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ Fuel ID: <b>${esc(res.fuelId)}</b> â€” à¸›à¸´à¸”à¸‡à¸²à¸™ Trip: <b>${esc(tripId)}</b>`);
    // Clear form
    document.getElementById("fuelLiters").value = "";
    document.getElementById("fuelPpl").value = "";
    document.getElementById("fuelAmount").value = "";
    document.getElementById("fuelNote").value = "";
    document.getElementById("fuelStartOdo").value = "";
    document.getElementById("fuelEndOdo").value = "";
    await Promise.all([loadTrips(), loadOrders(), refreshPickers()]);
  } else {
    setMsg("fuelMsg", false, esc(res.error || "à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ"));
  }
}

/* â”€â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadSummary() {
  const from = document.getElementById("sumFrom").value.trim();
  const to   = document.getElementById("sumTo").value.trim();
  const res  = await jsonp("summary", { from, to });
  const box  = document.getElementById("summaryBox");

  if (!res.ok) {
    box.innerHTML = `<div class="alert alert-danger">âœ— ${esc(res.error || "error")}</div>`;
    return;
  }

  const period = (from || to)
    ? `${from || "à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”"} à¸–à¸¶à¸‡ ${to || "à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™"}`
    : "à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”";

  // Fetch all trips to get odometer data
  const tripsRes = await jsonp("listTrips", { status: "" });
  const tripOdo = {};
  const tripToTruck = {};
  const tripToDriver = {};
  const tripToOrder = {};
  
  if (tripsRes.ok) {
    tripsRes.trips.forEach(t => {
      const start = parseFloat(t.startOdo) || 0;
      const end   = parseFloat(t.endOdo) || 0;
      const dist  = end > start ? end - start : 0;
      
      tripOdo[t.tripId] = dist;
      tripToTruck[t.tripId] = t.truckId;
      tripToDriver[t.tripId] = t.driverId;
      tripToOrder[t.tripId] = t.orderId;
    });
  }

  // Build tables for each breakdown
  const buildTable = (title, icon, data, groupBy) => {
    if (!data || !Object.keys(data).length) {
      return `<div class="card section-gap">
        <div class="card-header"><span>${icon}</span><span class="card-title">${title}</span></div>
        <div class="card-body"><div style="color:var(--gray-400);text-align:center;padding:20px">à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥</div></div>
      </div>`;
    }

    const rows = Object.entries(data)
      .sort((a, b) => b[1].amount - a[1].amount)
      .map(([id, val]) => {
        let efficiency = "-";
        let totalDist = 0;

        // Calculate total distance for this group
        Object.entries(tripOdo).forEach(([tripId, dist]) => {
          if (groupBy === "truck" && tripToTruck[tripId] === id) {
            totalDist += dist;
          } else if (groupBy === "driver" && tripToDriver[tripId] === id) {
            totalDist += dist;
          } else if (groupBy === "order" && tripToOrder[tripId] === id) {
            totalDist += dist;
          }
        });

        if (totalDist > 0 && val.liters > 0) {
          efficiency = (val.liters / totalDist).toFixed(3);
        }

        return `
          <tr>
            <td>${esc(id)}</td>
            <td class="text-right mono">${numFmt(val.liters)}</td>
            <td class="text-right mono">${numFmt(val.amount)}</td>
            <td class="text-right mono">${totalDist > 0 ? numFmt(totalDist) : "-"}</td>
            <td class="text-right mono">${efficiency}</td>
          </tr>
        `;
      }).join("");

    return `<div class="card section-gap">
      <div class="card-header"><span>${icon}</span><span class="card-title">${title}</span></div>
      <div class="card-body">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>à¸£à¸«à¸±à¸ª</th>
                <th class="text-right">à¸¥à¸´à¸•à¸£</th>
                <th class="text-right">à¸„à¹ˆà¸²à¸™à¹‰à¸³à¸¡à¸±à¸™ (à¸šà¸²à¸—)</th>
                <th class="text-right">à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡ (à¸à¸¡.)</th>
                <th class="text-right">à¸­à¸±à¸•à¸£à¸²à¸ªà¸´à¹‰à¸™à¹€à¸›à¸¥à¸·à¸­à¸‡ (à¸¥à¸´à¸•à¸£/à¸à¸¡.)</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>
    </div>`;
  };

  box.innerHTML = `
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-label">à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²</div>
        <div class="stat-value" style="font-size:18px;color:var(--blue)">${esc(period)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">à¸™à¹‰à¸³à¸¡à¸±à¸™à¸£à¸§à¸¡</div>
        <div class="stat-value">${numFmt(res.totalFuelLiters)}<span class="stat-unit">à¸¥à¸´à¸•à¸£</span></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">à¸„à¹ˆà¸²à¸™à¹‰à¸³à¸¡à¸±à¸™à¸£à¸§à¸¡</div>
        <div class="stat-value">${numFmt(res.totalFuelAmount)}<span class="stat-unit">à¸šà¸²à¸—</span></div>
      </div>
    </div>

    <div class="charts-row">
      <div class="chart-card">
        <div class="chart-title">ğŸ“ˆ à¸­à¸±à¸•à¸£à¸²à¸ªà¸´à¹‰à¸™à¹€à¸›à¸¥à¸·à¸­à¸‡à¸•à¸²à¸¡à¸£à¸–</div>
        <div class="chart-container"><canvas id="chartTruck"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">ğŸ“ˆ à¸­à¸±à¸•à¸£à¸²à¸ªà¸´à¹‰à¸™à¹€à¸›à¸¥à¸·à¸­à¸‡à¸•à¸²à¸¡à¸„à¸™à¸‚à¸±à¸š</div>
        <div class="chart-container"><canvas id="chartDriver"></canvas></div>
      </div>
    </div>

    ${buildTable("à¸ªà¸£à¸¸à¸›à¸•à¸²à¸¡à¸£à¸–", "ğŸš›", res.byTruck, "truck")}
    ${buildTable("à¸ªà¸£à¸¸à¸›à¸•à¸²à¸¡à¸„à¸™à¸‚à¸±à¸š", "ğŸ‘¨â€âœˆï¸", res.byDriver, "driver")}
    ${buildTable("à¸ªà¸£à¸¸à¸›à¸•à¸²à¸¡ Order", "ğŸ“¦", res.byOrder, "order")}
  `;

  // Render charts after DOM is ready
  setTimeout(() => {
    renderCharts(tripsRes.trips, tripOdo, tripToTruck, tripToDriver, from, to);
  }, 100);
}

/* â”€â”€â”€ Chart rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function renderCharts(trips, tripOdo, tripToTruck, tripToDriver, from, to) {
  if (!trips || !trips.length) return;

  // Fetch fuel logs to get actual fuel usage
  const fuelRes = await jsonp("summary", { from, to });
  if (!fuelRes.ok) return;

  // Build map of tripId -> actual fuel liters
  const tripFuel = {};
  
  // We need to fetch fuel logs separately since summary doesn't give us trip-level detail
  // For now, we'll use a different approach: group by date and calculate from trips
  
  const truckByDate = {};
  const driverByDate = {};

  trips.forEach(t => {
    const date = String(t.tripDate || '');
    if (from && date < from) return;
    if (to && date > to) return;

    const dist = tripOdo[t.tripId] || 0;
    if (dist <= 0) return;

    const truckId = tripToTruck[t.tripId];
    const driverId = tripToDriver[t.tripId];

    // For now, use plannedFuelLiters (later can be enhanced to use actual from FuelLogs)
    const liters = parseFloat(t.plannedFuelLiters) || 0;
    if (liters <= 0) return;

    const efficiency = liters / dist;

    // Group by truck and date
    if (truckId) {
      if (!truckByDate[truckId]) truckByDate[truckId] = {};
      if (!truckByDate[truckId][date]) truckByDate[truckId][date] = [];
      truckByDate[truckId][date].push(efficiency);
    }

    // Group by driver and date
    if (driverId) {
      if (!driverByDate[driverId]) driverByDate[driverId] = {};
      if (!driverByDate[driverId][date]) driverByDate[driverId][date] = [];
      driverByDate[driverId][date].push(efficiency);
    }
  });

  // Calculate daily averages
  const calcAvg = (groupData) => {
    const result = {};
    Object.entries(groupData).forEach(([id, dates]) => {
      result[id] = {};
      Object.entries(dates).forEach(([date, values]) => {
        result[id][date] = values.reduce((a, b) => a + b, 0) / values.length;
      });
    });
    return result;
  };

  const truckAvg = calcAvg(truckByDate);
  const driverAvg = calcAvg(driverByDate);

  // Get all dates
  const allDates = new Set();
  [...Object.values(truckAvg), ...Object.values(driverAvg)].forEach(dates => {
    Object.keys(dates).forEach(d => allDates.add(d));
  });
  const sortedDates = Array.from(allDates).sort();

  if (sortedDates.length === 0) {
    // No data to display
    return;
  }

  // Format dates to DD/MM
  const formattedDates = sortedDates.map(d => {
    const parts = d.split('-');
    if (parts.length === 3) {
      return `${parts[2]}/${parts[1]}`; // DD/MM
    }
    return d;
  });

  // Chart colors - extended for more trucks/drivers
  const colors = [
    '#1557c0', '#d67b00', '#1a8c5c', '#d63b3b', 
    '#5b21b6', '#0369a1', '#be123c', '#047857',
    '#7c3aed', '#ea580c', '#0891b2', '#dc2626'
  ];

  const makeDatasets = (avgData) => {
    return Object.entries(avgData).map(([id, dates], idx) => {
      const color = colors[idx % colors.length];
      return {
        label: id,
        data: sortedDates.map(date => dates[date] !== undefined ? dates[date] : null),
        backgroundColor: color,
        borderColor: color,
        borderWidth: 0,
        borderRadius: 6,
        borderSkipped: false
      };
    });
  };

  const chartConfig = {
    responsive: true,
    maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { 
        position: 'top',
        labels: { 
          font: { family: 'IBM Plex Sans Thai', size: 12, weight: '600' },
          padding: 12,
          usePointStyle: true,
          pointStyle: 'rect'
        }
      },
      tooltip: {
        backgroundColor: 'rgba(13, 47, 94, 0.95)',
        titleFont: { family: 'IBM Plex Sans Thai', size: 13 },
        bodyFont: { family: 'IBM Plex Mono', size: 12 },
        padding: 12,
        callbacks: {
          label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(3)} à¸¥à¸´à¸•à¸£/à¸à¸¡.`
        }
      }
    },
    scales: {
      x: {
        title: { 
          display: true, 
          text: 'à¸§à¸±à¸™à¸—à¸µà¹ˆ',
          font: { family: 'IBM Plex Sans Thai', size: 12, weight: '600' }
        },
        ticks: { 
          font: { family: 'IBM Plex Mono', size: 10 },
          maxRotation: 45,
          minRotation: 45
        },
        grid: { display: false }
      },
      y: {
        title: { 
          display: true, 
          text: 'à¸¥à¸´à¸•à¸£/à¸à¸¡.',
          font: { family: 'IBM Plex Sans Thai', size: 12, weight: '600' }
        },
        ticks: { 
          font: { family: 'IBM Plex Mono', size: 10 },
          callback: (val) => val.toFixed(2)
        },
        beginAtZero: true,
        grid: { color: 'rgba(0,0,0,0.05)' }
      }
    }
  };

  // Destroy existing charts if they exist
  if (window.chartTruck && typeof window.chartTruck.destroy === 'function') {
    window.chartTruck.destroy();
  }
  if (window.chartDriver && typeof window.chartDriver.destroy === 'function') {
    window.chartDriver.destroy();
  }

  // Render truck chart
  const ctxTruck = document.getElementById('chartTruck');
  if (ctxTruck && Object.keys(truckAvg).length > 0) {
    window.chartTruck = new Chart(ctxTruck, {
      type: 'bar',
      data: { labels: formattedDates, datasets: makeDatasets(truckAvg) },
      options: chartConfig
    });
  }

  // Render driver chart
  const ctxDriver = document.getElementById('chartDriver');
  if (ctxDriver && Object.keys(driverAvg).length > 0) {
    window.chartDriver = new Chart(ctxDriver, {
      type: 'bar',
      data: { labels: formattedDates, datasets: makeDatasets(driverAvg) },
      options: chartConfig
    });
  }
}

/* â”€â”€â”€ Data Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function addCustomer() {
  const id = document.getElementById("newCusId").value.trim();
  const name = document.getElementById("newCusName").value.trim();
  if (!id || !name) {
    setMsg("cusMsg", false, "à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸š");
    return;
  }
  const res = await jsonp("addDDL", { type: "CUSTOMER", id, name });
  if (res.ok) {
    setMsg("cusMsg", true, `à¹€à¸à¸´à¹ˆà¸¡à¸¥à¸¹à¸à¸„à¹‰à¸² <b>${esc(name)}</b> à¸ªà¸³à¹€à¸£à¹‡à¸ˆ`);
    document.getElementById("newCusId").value = "";
    document.getElementById("newCusName").value = "";
    await loadAll();
  } else {
    setMsg("cusMsg", false, esc(res.error || "à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ"));
  }
}

async function addProduct() {
  const id = document.getElementById("newPrdId").value.trim();
  const name = document.getElementById("newPrdName").value.trim();
  if (!id || !name) {
    setMsg("prdMsg", false, "à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸š");
    return;
  }
  const res = await jsonp("addDDL", { type: "PRODUCT", id, name });
  if (res.ok) {
    setMsg("prdMsg", true, `à¹€à¸à¸´à¹ˆà¸¡à¸ªà¸´à¸™à¸„à¹‰à¸² <b>${esc(name)}</b> à¸ªà¸³à¹€à¸£à¹‡à¸ˆ`);
    document.getElementById("newPrdId").value = "";
    document.getElementById("newPrdName").value = "";
    await loadAll();
  } else {
    setMsg("prdMsg", false, esc(res.error || "à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ"));
  }
}

async function addDriver() {
  const id = document.getElementById("newDrvId").value.trim();
  const name = document.getElementById("newDrvName").value.trim();
  if (!id || !name) {
    setMsg("drvMsg", false, "à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸š");
    return;
  }
  const res = await jsonp("addDDL", { type: "DRIVER", id, name });
  if (res.ok) {
    setMsg("drvMsg", true, `à¹€à¸à¸´à¹ˆà¸¡à¸à¸™à¸±à¸à¸‡à¸²à¸™ <b>${esc(name)}</b> à¸ªà¸³à¹€à¸£à¹‡à¸ˆ`);
    document.getElementById("newDrvId").value = "";
    document.getElementById("newDrvName").value = "";
    await loadAll();
  } else {
    setMsg("drvMsg", false, esc(res.error || "à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ"));
  }
}

async function addTruck() {
  const id = document.getElementById("newTrkId").value.trim();
  const name = document.getElementById("newTrkName").value.trim();
  if (!id || !name) {
    setMsg("trkMsg", false, "à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸š");
    return;
  }
  const res = await jsonp("addDDL", { type: "TRUCK", id, name });
  if (res.ok) {
    setMsg("trkMsg", true, `à¹€à¸à¸´à¹ˆà¸¡à¸£à¸– <b>${esc(name)}</b> à¸ªà¸³à¹€à¸£à¹‡à¸ˆ`);
    document.getElementById("newTrkId").value = "";
    document.getElementById("newTrkName").value = "";
    await loadAll();
  } else {
    setMsg("trkMsg", false, esc(res.error || "à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ"));
  }
}

/* â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.addEventListener("load", () => {
  initDatePickers();
  if (SCRIPT_URL && !SCRIPT_URL.includes("PASTE_")) loadAll();
});
</script>
</body>
</html>
