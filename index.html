<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transport Office</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f6f7fb; }
    .card { border:0; box-shadow: 0 8px 24px rgba(15,23,42,.06); border-radius: 16px; }
    .nav-pills .nav-link { border-radius: 999px; }
    .small-muted { font-size:.9rem; color:#64748b; }
    pre { background:#0b1020; color:#d1e7ff; padding:12px; border-radius:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
<div class="container py-4">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h3 class="mb-0">üöö Transport Office</h3>
      <div class="small-muted">‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ‚Üí ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô(‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô) ‚Üí ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢ ‚Üí ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏Å‡∏•‡∏±‡∏ö ‚Üí ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</div>
    </div>
    <button class="btn btn-outline-primary" onclick="bootstrap()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  </div>

  <div class="alert alert-warning">
    <div class="fw-bold">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SCRIPT_URL ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
    <div class="small">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤ <span class="mono">https://script.google.com/macros/s/AKfycbydYXCZioSSBk_wX6Hflo_QEhmal0glbhPRQDKBXqrlkkMnXFmgCoJ2VoegYqE_oYj5/exec</span> ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå Deploy ‡∏Ç‡∏≠‡∏á Apps Script</div>
  </div>

  <ul class="nav nav-pills gap-2 mb-3" id="tabs">
    <li class="nav-item"><button class="nav-link active" data-tab="tabOrder">1) ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button></li>
    <li class="nav-item"><button class="nav-link" data-tab="tabPlan">2) ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô/‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</button></li>
    <li class="nav-item"><button class="nav-link" data-tab="tabFuel">3) ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button></li>
    <li class="nav-item"><button class="nav-link" data-tab="tabSummary">4) ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</button></li>
  </ul>

  <!-- TAB 1: Orders -->
  <div id="tabOrder" class="tab-pane">
    <div class="card p-3 mb-3">
      <h5 class="mb-3">üì• ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h5>
      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
          <select id="customerId" class="form-select"></select>
        </div>
        <div class="col-md-4">
          <label class="form-label">‡∏ß‡∏±‡∏ô‡∏™‡πà‡∏á (YYYY-MM-DD)</label>
          <input id="shipDate" class="form-control" placeholder="2026-02-17">
        </div>
        <div class="col-md-4">
          <label class="form-label">‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á</label>
          <input id="destination" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä / ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô A">
        </div>

        <div class="col-md-4">
          <label class="form-label">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
          <select id="product" class="form-select"></select>
        </div>
        <div class="col-md-2">
          <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
          <input id="qty" class="form-control" type="number" step="0.01" placeholder="‡πÄ‡∏ä‡πà‡∏ô 30">
        </div>
        <div class="col-md-2">
          <label class="form-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
          <input id="unit" class="form-control" value="‡∏ï‡∏±‡∏ô">
        </div>
        <div class="col-md-2">
          <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
          <input id="ppu" class="form-control" type="number" step="0.01" placeholder="0 = ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö">
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button class="btn btn-primary w-100" onclick="createOrder()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
        </div>

        <div class="col-12">
          <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <input id="orderNote" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô / ‡πÇ‡∏ó‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á">
        </div>
      </div>
      <div id="orderMsg" class="mt-3"></div>
    </div>

    <div class="card p-3">
      <div class="d-flex align-items-center justify-content-between">
        <h5 class="mb-0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h5>
        <select id="orderStatusFilter" class="form-select" style="max-width:220px" onchange="loadOrders()">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="NEW">NEW</option>
          <option value="PLANNED">PLANNED</option>
          <option value="ASSIGNED">ASSIGNED</option>
          <option value="CLOSED">CLOSED</option>
        </select>
      </div>
      <div class="table-responsive mt-2">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>OrderId</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏ß‡∏±‡∏ô‡∏™‡πà‡∏á</th><th>‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="text-end">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>Status</th>
            </tr>
          </thead>
          <tbody id="ordersTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB 2: Plan/Assign -->
  <div id="tabPlan" class="tab-pane d-none">
    <div class="card p-3 mb-3">
      <h5 class="mb-3">üó∫Ô∏è ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô) + üë®‚Äç‚úàÔ∏è ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</h5>
      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å OrderId</label>
          <select id="planOrderId" class="form-select"></select>
        </div>
        <div class="col-md-2">
          <label class="form-label">‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô (‡∏•‡∏¥‡∏ï‡∏£)</label>
          <input id="plannedLiters" class="form-control" type="number" step="0.01">
        </div>
        <div class="col-md-2">
          <label class="form-label">‡∏á‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
          <input id="plannedBudget" class="form-control" type="number" step="0.01">
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button class="btn btn-outline-primary w-100" onclick="planOrder()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô</button>
        </div>

        <div class="col-md-2">
          <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏ß‡∏¥‡πà‡∏á</label>
          <input id="tripDate" class="form-control" placeholder="2026-02-17">
        </div>
        <div class="col-md-4">
          <label class="form-label">‡∏£‡∏ñ</label>
          <select id="truckId" class="form-select"></select>
        </div>
        <div class="col-md-4">
          <label class="form-label">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</label>
          <select id="driverId" class="form-select"></select>
        </div>
        <div class="col-md-4">
          <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢)</label>
          <input id="assignNote" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á/‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠">
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button class="btn btn-primary w-100" onclick="assignOrder()">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</button>
        </div>
      </div>
      <div id="planMsg" class="mt-3"></div>
    </div>

    <div class="card p-3">
      <div class="d-flex align-items-center justify-content-between">
        <h5 class="mb-0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Trips</h5>
        <select id="tripStatusFilter" class="form-select" style="max-width:220px" onchange="loadTrips()">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="ASSIGNED">ASSIGNED</option>
          <option value="DELIVERED">DELIVERED</option>
          <option value="CLOSED">CLOSED</option>
        </select>
      </div>
      <div class="table-responsive mt-2">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>TripId</th><th>OrderId</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏ñ</th><th>‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</th><th>Status</th>
              <th class="text-end">Plan Liters</th><th class="text-end">Plan Budget</th>
            </tr>
          </thead>
          <tbody id="tripsTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB 3: Fuel -->
  <div id="tabFuel" class="tab-pane d-none">
    <div class="card p-3 mb-3">
      <h5 class="mb-3">‚õΩ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô (‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö)</h5>
      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å TripId</label>
          <select id="fuelTripId" class="form-select"></select>
        </div>
        <div class="col-md-2">
          <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏°</label>
          <input id="fuelDate" class="form-control" placeholder="2026-02-17">
        </div>
        <div class="col-md-2">
          <label class="form-label">‡∏•‡∏¥‡∏ï‡∏£</label>
          <input id="fuelLiters" class="form-control" type="number" step="0.01">
        </div>
        <div class="col-md-2">
          <label class="form-label">‡∏ö‡∏≤‡∏ó/‡∏•‡∏¥‡∏ï‡∏£</label>
          <input id="fuelPpl" class="form-control" type="number" step="0.01">
        </div>
        <div class="col-md-2">
          <label class="form-label">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏ñ‡πâ‡∏≤‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡πâ)</label>
          <input id="fuelAmount" class="form-control" type="number" step="0.01">
        </div>
        <div class="col-12">
          <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <input id="fuelNote" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ï‡∏¥‡∏°‡∏õ‡∏±‡πä‡∏°‡πÑ‡∏´‡∏ô / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà...">
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button class="btn btn-primary w-100" onclick="fuelReturn()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>
        </div>
      </div>
      <div id="fuelMsg" class="mt-3"></div>
    </div>
  </div>

  <!-- TAB 4: Summary -->
  <div id="tabSummary" class="tab-pane d-none">
    <div class="card p-3">
      <h5 class="mb-3">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô)</h5>
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà (YYYY-MM-DD)</label>
          <input id="sumFrom" class="form-control" placeholder="2026-02-01">
        </div>
        <div class="col-md-3">
          <label class="form-label">‡∏ñ‡∏∂‡∏á (YYYY-MM-DD)</label>
          <input id="sumTo" class="form-control" placeholder="2026-02-28">
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" onclick="loadSummary()">‡∏™‡∏£‡∏∏‡∏õ</button>
        </div>
      </div>

      <div id="summaryBox" class="mt-3"></div>
    </div>
  </div>

</div>

<script>
/** üëâ ‡πÉ‡∏™‡πà URL ‡∏ï‡∏≠‡∏ô Deploy Apps Script (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec) */
const SCRIPT_URL = "PASTE_YOUR_APPS_SCRIPT_WEBAPP_URL_HERE";

/** ---------- JSONP helper ---------- */
function jsonp(action, params = {}) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const url = new URL(SCRIPT_URL);
    url.searchParams.set("action", action);
    url.searchParams.set("callback", cb);

    Object.keys(params).forEach(k => {
      if (params[k] !== undefined && params[k] !== null) {
        url.searchParams.set(k, params[k]);
      }
    });

    const script = document.createElement("script");
    script.src = url.toString();
    script.onerror = () => {
      cleanup();
      reject(new Error("JSONP request failed"));
    };

    window[cb] = (data) => {
      cleanup();
      resolve(data);
    };

    function cleanup() {
      delete window[cb];
      script.remove();
    }

    document.body.appendChild(script);
  });
}

/** ---------- UI helpers ---------- */
function setMsg(id, ok, text) {
  document.getElementById(id).innerHTML =
    `<div class="alert ${ok ? "alert-success" : "alert-danger"} mb-0">${text}</div>`;
}

function optionize(selectId, items, placeholder="-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --") {
  const el = document.getElementById(selectId);
  el.innerHTML = `<option value="">${placeholder}</option>` +
    items.map(x => `<option value="${escapeHtml(x.id)}">${escapeHtml(x.name)} (${escapeHtml(x.id)})</option>`).join("");
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

/** ---------- Tabs ---------- */
document.querySelectorAll("#tabs .nav-link").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll("#tabs .nav-link").forEach(x => x.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    document.querySelectorAll(".tab-pane").forEach(p => p.classList.add("d-none"));
    document.getElementById(tab).classList.remove("d-none");
  });
});

/** ---------- App state ---------- */
let DDL = { drivers:[], trucks:[], customers:[], products:[] };

/** ---------- Load bootstrap ---------- */
async function bootstrap() {
  if (!SCRIPT_URL || SCRIPT_URL.includes("PASTE_")) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ SCRIPT_URL ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå /exec ‡∏à‡∏≤‡∏Å Apps Script ‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }
  const data = await jsonp("bootstrap");
  if (!data.ok) { alert(data.error || "bootstrap error"); return; }

  DDL = data.ddl;

  optionize("customerId", DDL.customers, "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --");
  optionize("product", DDL.products, "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --");

  optionize("truckId", DDL.trucks, "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ --");
  optionize("driverId", DDL.drivers, "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö --");

  await loadOrders();
  await loadTrips();
  await refreshPickers();
}

async function refreshPickers() {
  // Orders for planning
  const orders = await jsonp("listOrders", { status: "" });
  if (orders.ok) {
    const items = orders.orders.map(o => ({ id: o.orderId, name: `${o.orderId} | ${o.customerName} | ${o.shipDate} | ${o.status}` }));
    optionize("planOrderId", items, "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Order --");
  }
  // Trips for fuel
  const trips = await jsonp("listTrips", { status: "ASSIGNED" });
  if (trips.ok) {
    const items = trips.trips.map(t => ({ id: t.tripId, name: `${t.tripId} | ${t.orderId} | ${t.truckName} | ${t.driverName}` }));
    optionize("fuelTripId", items, "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Trip --");
  }
}

/** ---------- Orders ---------- */
async function createOrder() {
  const customerId = document.getElementById("customerId").value;
  const customerName = (DDL.customers.find(x => x.id === customerId) || {}).name || "";
  const shipDate = document.getElementById("shipDate").value.trim();
  const destination = document.getElementById("destination").value.trim();
  const product = document.getElementById("product").value.trim() || document.getElementById("product").value;
  const qty = document.getElementById("qty").value;
  const unit = document.getElementById("unit").value.trim();
  const pricePerUnit = document.getElementById("ppu").value;
  const note = document.getElementById("orderNote").value.trim();

  const payload = {
    customerId, customerName, shipDate,
    origin: "", destination,
    product: (DDL.products.find(x => x.id === product)?.name) || product,
    qty, unit, pricePerUnit, note
  };

  const encoded = encodeURIComponent(JSON.stringify(payload));
  const res = await jsonp("createOrder", { payload: encoded });

  if (res.ok) {
    setMsg("orderMsg", true, `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à OrderId: <b>${res.orderId}</b>`);
    await loadOrders();
    await refreshPickers();
  } else {
    setMsg("orderMsg", false, res.error || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }
}

async function loadOrders() {
  const status = document.getElementById("orderStatusFilter").value;
  const res = await jsonp("listOrders", { status });

  const tb = document.getElementById("ordersTbody");
  tb.innerHTML = "";
  if (!res.ok) {
    tb.innerHTML = `<tr><td colspan="7" class="text-danger">${escapeHtml(res.error || "error")}</td></tr>`;
    return;
  }

  res.orders.slice(0,200).forEach(o => {
    tb.innerHTML += `
      <tr>
        <td class="mono">${escapeHtml(o.orderId)}</td>
        <td>${escapeHtml(o.customerName || "")}</td>
        <td class="mono">${escapeHtml(o.shipDate || "")}</td>
        <td>${escapeHtml(o.destination || "")}</td>
        <td>${escapeHtml(o.product || "")}</td>
        <td class="text-end">${escapeHtml(o.qty)}</td>
        <td><span class="badge text-bg-secondary">${escapeHtml(o.status)}</span></td>
      </tr>
    `;
  });
}

/** ---------- Plan & Assign ---------- */
async function planOrder() {
  const orderId = document.getElementById("planOrderId").value;
  const plannedFuelLiters = document.getElementById("plannedLiters").value;
  const plannedFuelBudget = document.getElementById("plannedBudget").value;

  const res = await jsonp("planOrder", { orderId, plannedFuelLiters, plannedFuelBudget });
  if (res.ok) {
    setMsg("planMsg", true, `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à OrderId: <b>${orderId}</b>`);
    await loadOrders();
    await refreshPickers();
  } else {
    setMsg("planMsg", false, res.error || "‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }
}

async function assignOrder() {
  const orderId = document.getElementById("planOrderId").value;
  const tripDate = document.getElementById("tripDate").value.trim();
  const truckId = document.getElementById("truckId").value;
  const driverId = document.getElementById("driverId").value;
  const note = document.getElementById("assignNote").value.trim();

  const res = await jsonp("assignOrder", { orderId, tripDate, truckId, driverId, note });
  if (res.ok) {
    setMsg("planMsg", true, `‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à TripId: <b>${res.tripId}</b>`);
    await loadTrips();
    await refreshPickers();
    await loadOrders();
  } else {
    setMsg("planMsg", false, res.error || "‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }
}

async function loadTrips() {
  const status = document.getElementById("tripStatusFilter").value;
  const res = await jsonp("listTrips", { status });

  const tb = document.getElementById("tripsTbody");
  tb.innerHTML = "";
  if (!res.ok) {
    tb.innerHTML = `<tr><td colspan="8" class="text-danger">${escapeHtml(res.error || "error")}</td></tr>`;
    return;
  }

  res.trips.slice(0,200).forEach(t => {
    tb.innerHTML += `
      <tr>
        <td class="mono">${escapeHtml(t.tripId)}</td>
        <td class="mono">${escapeHtml(t.orderId)}</td>
        <td class="mono">${escapeHtml(t.tripDate || "")}</td>
        <td>${escapeHtml(t.truckName || t.truckId)}</td>
        <td>${escapeHtml(t.driverName || t.driverId)}</td>
        <td><span class="badge text-bg-secondary">${escapeHtml(t.status)}</span></td>
        <td class="text-end">${escapeHtml(t.plannedFuelLiters)}</td>
        <td class="text-end">${escapeHtml(t.plannedFuelBudget)}</td>
      </tr>
    `;
  });
}

/** ---------- Fuel ---------- */
async function fuelReturn() {
  const tripId = document.getElementById("fuelTripId").value;
  const fuelDate = document.getElementById("fuelDate").value.trim();
  const liters = document.getElementById("fuelLiters").value;
  const pricePerLiter = document.getElementById("fuelPpl").value;
  const amount = document.getElementById("fuelAmount").value;
  const note = document.getElementById("fuelNote").value.trim();

  const res = await jsonp("fuelReturn", { tripId, fuelDate, liters, pricePerLiter, amount, note });
  if (res.ok) {
    setMsg("fuelMsg", true, `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à FuelId: <b>${res.fuelId}</b> ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô TripId: <b>${tripId}</b>`);
    await loadTrips();
    await loadOrders();
    await refreshPickers();
  } else {
    setMsg("fuelMsg", false, res.error || "‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }
}

/** ---------- Summary ---------- */
async function loadSummary() {
  const from = document.getElementById("sumFrom").value.trim();
  const to = document.getElementById("sumTo").value.trim();
  const res = await jsonp("summary", { from, to });

  const box = document.getElementById("summaryBox");
  if (!res.ok) {
    box.innerHTML = `<div class="alert alert-danger">${escapeHtml(res.error || "error")}</div>`;
    return;
  }

  box.innerHTML = `
    <div class="row g-2">
      <div class="col-md-4">
        <div class="card p-3">
          <div class="small-muted">Fuel liters</div>
          <div class="fs-3 fw-bold">${Number(res.totalFuelLiters || 0).toFixed(2)}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3">
          <div class="small-muted">Fuel cost (‡∏ö‡∏≤‡∏ó)</div>
          <div class="fs-3 fw-bold">${Number(res.totalFuelAmount || 0).toFixed(2)}</div>
        </div>
      </div>
      <div class="col-12">
        <div class="card p-3">
          <div class="fw-bold mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (byTruck/byDriver/byOrder)</div>
          <pre class="mb-0">${escapeHtml(JSON.stringify({ byTruck: res.byTruck, byDriver: res.byDriver, byOrder: res.byOrder }, null, 2))}</pre>
        </div>
      </div>
    </div>
  `;
}

/** Auto bootstrap on load (after you set SCRIPT_URL) */
window.addEventListener("load", () => {
  // do nothing until user sets SCRIPT_URL
});
</script>

</body>
</html>
